
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="description" content="" />
<meta name="author" content="" />
<script src=https://code.jquery.com/jquery-3.6.0.min.js></script>


 <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"
      integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
<script
	src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
	integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
	crossorigin="anonymous"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
	integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
	crossorigin="anonymous"></script>

<title>Corporate Eye Admin - Manage Groups</title>

<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link
	href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css"
	rel="stylesheet" />

<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
	integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
	crossorigin="anonymous">

<link href="css/styles.css" rel="stylesheet" />
<link href="css/commonstyles.css" rel="stylesheet" />
<script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js"
	crossorigin="anonymous"></script>
</head>
<body class="sb-nav-fixed">

	<span th:replace="fragments/header :: nav"></span>
	<div id="layoutSidenav">

		<span th:replace="fragments/nav :: navside"></span>

		<div id="layoutSidenav_content">
			<main>
				<div class="container-fluid px-4">
					<h1 class="mt-4">Manage Groups</h1>


					<div class="row">

						<div class="col-xl-12">
							<div class="card">
								<div class="card-body">

									<div class="table-responsive">
										<div id="zero_config_wrapper"
											class="dataTables_wrapper container-fluid dt-bootstrap4">

											<div class="row" style="margin-bottom: 10px">

												<div class="col-sm-6">

													<label>Search:<input id="searchInput"
														onKeyUp="getTableData(this.value)" type="search"
														class="form-control form-control-sm" th:value="${keyword}"
														placeholder="" aria-controls="zero_config"></label>

												</div>
												<div class="offset-4 col-sm-2" style="margin-top: 10px">
													<button class="btn btn-success" style="float: right"
														data-toggle="modal" data-target="#addModal"
														data-mode="add" data-id="Add">Add Group</button>
												</div>
											</div>
											<div id="tableContent"></div>

										</div>

									</div>
								</div>
							</div>
						</div>
					</div>

				</div>
			</main>


			<!-- #modal -->
			<div class="toast" role="alert" aria-live="assertive"
				aria-atomic="true"
				style="position: absolute; bottom: 20px; right: 20px;">
				<div class="toast-header">

					<strong class="mr-auto">Alert</strong>

					<button type="button" class="ml-2 mb-1 close" data-dismiss="toast"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="toast-body" id="toastMessage">Hello, world! This
					is a toast message.</div>
			</div>




			<div class="modal fade" id="confirm-delete" tabindex="-1"
				role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header" id="confirmHeader">...</div>
						<div class="modal-body" id="confirmBody">...</div>
						<div class="modal-footer">
							<button type="button" id="cModalCancel" class="btn btn-default"
								data-dismiss="modal">Cancel</button>
							<a class="btn btn-danger btn-ok">Delete</a>
						</div>
					</div>
				</div>
			</div>



			<span th:replace="fragments/footer :: footer"></span>

		</div>
	</div>




	<div class="modal fade" id="addModal" tabindex="-1" role="dialog"
		aria-labelledby="addModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="addModalLabel">Add Group</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form>

						<input type="hidden" class="form-control" id="f_id">

						<div class="form-group">
							<label for="f_groupname" class="col-form-label">Group
								Name:</label> <input type="text" class="form-control" id="f_groupname" placeholder="Minimum 4 characters">
							<div style="height: 10px; margin-bottom: 30px">
								<label for="f_groupname" id="groupnameStatus"
									class="col-form-label text-danger "
									style="display: none; float: right;">Group name Already
									Exist</label>
							</div>
						</div>
						<hr>
						<div class="form-group">
							<label for="f_name" class="col-form-label" style="display: block">Users:</label>
							<input type="text" class="form-control" id="f_name" placeholder="Seach by Username , name or role">
							

							
								<div id="log"
									style="    max-height: 200px;  width: 300px;   overflow: auto;   display:none; position: absolute;    z-index: 99;   "
									class="ui-widget-content"></div>
							
						</div>

						<div id="userlist">

							<div class="alert alert-primary" role="alert">
 								No users in this group!
							</div>

						</div>
						<div></div>


						<div class="form-group">
							<label for="" id="f_status" class="col-form-label text-danger"></label>
						</div>
					</form>
				</div>
				<div class="modal-footer">
					<button id="closeModal" type="button" class="btn btn-secondary"
						data-dismiss="modal">Close</button>
					<button type="button" id="submitButton" class="btn btn-primary">Submit</button>
				</div>
			</div>
		</div>
	</div>


	<script>
		
	</script>

	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
		crossorigin="anonymous"></script>
	<script src="js/scripts.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"
		crossorigin="anonymous"></script>

	<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"
		crossorigin="anonymous"></script>
	<script src="js/datatables-simple-demo.js"></script>

	<script>
	
		var editingGroupName = "";	
	
		var currentUsername = "[[${#httpServletRequest.remoteUser}]]";

		var groupValid = false;

		function validate() {
			
			
			formValid = true;

			if ($("#f_groupname").val().trim().length < 4) {
				$("#f_status").html(
						"Group Name should be atleast 4 characters long");
				formValid = false;
			} else if (!groupValid) {
				$("#f_status")
						.html(
								"Group Name Already Exist. Choose a different groupname");
				formValid = false;
			}

			
			if (formValid) {

				groupname = $("#f_groupname").val();
				usernames = userList;
				data = JSON.stringify({  "groupName" :  groupname ,
					usernames });

				$
						.ajax({
							type : "POST",
							url : "ajax/addgroup",
							data : data,
							contentType : "application/json; charset=UTF-8",
							success : function(data) {
								if (data == "success") {
									getTableData($("#searchInput").val());
									$("#closeModal").click();
									$("#toastMessage").html(
											"<span class='text-success'>Group "
													+ groupname
													+ " created!</span>");
									$('.toast').toast('show');
								} else {
									getTableData($("#searchInput").val());
									$("#toastMessage")
											.html(
													"<span class='text-danger'>User creation failed!</span>");
									$('.toast').toast('show');
								}
							}

						});

			}

		}

		function validateEdit() {
			formValid = true;

			if ($("#f_groupname").val().trim().length < 4) {
				$("#f_status").html(
						"Group name should be atleast 4 characters long");
				formValid = false;
			}

			if (formValid) {

				id = $("#f_id").val();
				groupname = $("#f_groupname").val();

				usernames = userList;
				
				data = JSON.stringify({ "id" : id, "groupName" :  groupname ,
					usernames });

				$
						.ajax({
							type : "POST",
							url : "ajax/updateGroup",
							data : data,
							contentType : "application/json; charset=UTF-8",
							success : function(data) {
								
								editingGroupName = "";
								if (data == "success") {
									
									resetValues();
									getTableData($("#searchInput").val());
									$("#closeModal").click();
									$("#toastMessage").html(
											"<span class='text-success'>Group "
													+ groupname
													+ " updated!</span>");
									$('.toast').toast('show');
								} else {
									getTableData($("#searchInput").val());
									$("#toastMessage")
											.html(
													"<span class='text-danger'>Group updation failed!</span>");
									$('.toast').toast('show');
								}
							}

						});

			}

		}

		function resetValues() {

			$("#groupnameStatus").hide();
			$('input[type="text"]').each(function() {
				$(this).val("");
			});

			$("#f_groupname").prop('disabled', false);
			
			userList = {};
			generateList();

		}

		function getTableData(keyword) {

			$.get("ajax/groupTableContent?query=" + keyword, function(data,
					status) {
				//alert("Data: " + data + "\nStatus: " + status);
				$("#tableContent").html(data);

			});

		}

		function setValues(id) {
			$.get("ajax/getGroupDataById?id=" + id, function(data, status) {
				//alert("Data: " + data + "\nStatus: " + status);
				editingGroupName = data.name;
				$("#f_groupname").val(data.name);
				$("#groupnameStatus").hide();
				$("#f_id").val(data.id);
				userList = {};
				$(data.users).each(function(val,obj){
					 addToList(obj.username,obj.name);
					
					
				});
				generateList();

			});
		}

		var userList = {};

		function removeFromList(username)
		{
			delete userList[username];
			generateList();
		}
		
		function addToList(username,name) {
			
			
			userList[username] = name;
			
			console.log(userList);
			
			$("#f_name").val("");
			performUserSearch("");
			generateList();
		}

		function generateList() {
			content ="";
			
		
		
			Object.entries(userList).forEach(function([key, value])  {
			
				content+=	'<div class="userListItem border rounded"><div class="text-primary nameitem">'+
				value
				+'</div><div class="deleteUser" data-username="'+key+'"><i class="fa fa-close" style="color: red"></i></div></div>'
				
			
		});
			
		
			
			$("#userlist").html(content);
			$(".deleteUser").off("click");
			$(".deleteUser").on("click",function(){
				removeFromList($(event.currentTarget).data('username'));
			});
		
		}
		
	
		
		$(document).ready(
				function() {

				
					getTableData($("#searchInput").val());

					$("#f_groupname").on(
							"keyup",
							function() {
								var groupname = $(this).val();
								$.get("ajax/checkgroupname?groupname="
										+ groupname, function(data, status) {
									//alert("Data: " + data + "\nStatus: " + status);
									if (data == true  ) {
										console.log($("#f_groupname").val(), editingGroupName);
										if($("#f_groupname").val()!= editingGroupName)
										{																		
										$("#groupnameStatus").show();
										groupValid = false;
										$("#groupnameStatus").html(
												"Groupname Already Exist");
										$("#groupnameStatus").removeClass(
												"text-success");
										$("#groupnameStatus").addClass(
												"text-danger");
										}
										else
											{
											$("#groupnameStatus").hide();
											}

									} else {

										if (groupname.length > 3) {
											groupValid = true;
											$("#groupnameStatus").show();
											$("#groupnameStatus").html(
													"groupname Available");
											$("#groupnameStatus").removeClass(
													"text-danger");
											$("#groupnameStatus").addClass(
													"text-success");
										} else {
											$("#groupnameStatus").hide();
										}
									}

								});

							});		
					
										

			
					

				});

		$('#confirm-delete').on(
				'click',
				'.btn-ok',
				function(e) {

					var $modalDiv = $(e.delegateTarget);
					var id = $(this).data('recordId');
					var groupname = $(this).data('groupname');
					$modalDiv.addClass('loading');
					$.post('/ajax/deleteGroup/' + id).then(
							function() {
								$modalDiv.modal('hide').removeClass('loading');
								getTableData($("#searchInput").val());
								$("#toastMessage").html(
										"<span class='text-success'>Group "
												+ groupname
												+ " deleted!</span>");
								$('.toast').toast('show');
								$('#cModalCancel').click();
							});
				});

		// Bind to modal opening to set necessary data properties to be used to make request
		$('#confirm-delete').on(
				'show.bs.modal',
				function(e) {
					var button = $(e.relatedTarget);

					console.log(button.data('id'));
					$("#confirmHeader").text("Confirm Delete?");
					$("#confirmBody").text(
							"Do you really want to delete Group "
									+ button.data("groupname") + "?");
					$('.title', this).text(
							"Do you really want to delete Group "
									+ button.data("groupname") + "?");
					$('.btn-ok', this).data('recordId', button.data("id"))
							.data('groupname', button.data("groupname"));
				});

		$('#addModal').on('show.bs.modal', function(event) {
			
			userList = {};
			
			generateList();

			var button = $(event.relatedTarget) // Button that triggered the modal
			var id = button.data('id') // Extract info from data-* attributes
			// If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
			// Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
			var mode = button.data('mode')

			var modal = $(this)

			if (mode == "add") {
				$("#submitButton").off("click");

				$("#submitButton").on("click", function() {

					validate();

				});
				resetValues();
			} else if (mode == "edit") {

				$("#submitButton").off("click");

				$("#submitButton").on("click", function() {

					validateEdit();

				});
				setValues(id);

			}
			
			
			//	modal.find('.modal-title').text('New message to ' + recipient)
			//modal.find('.modal-body input').val(recipient)
		})
	</script>
  <script>
  
  function log( message ) {
	   // console.log(message);
	   	$("#log").show();
	  
	    content = "<div class=\"list-group\">";
	    	
	     $(message).each(function(index,val){
	    	 if(userList[val.username] == undefined)
	    	 {
	    	   
	    	 
	    	 content+= '<a  class="list-group-item list-group-item-action suggestion-list-item" data-username="'+val.username+'" style="cursor:pointer">' +val.name + "</a>";
	    	 }
	    	});
	     
	     content+= "</div>";
	    
	      $( "#log" ).html( content );
	      $( "#log" ).scrollTop( 0 );
	      
	      $('.suggestion-list-item').off("click");
	      $('.suggestion-list-item').on('click', function(event) {
			    // 'this' here = externalObject
			  addToList( $(event.currentTarget).data('username'), $(event.currentTarget).text());
			});
	    }
  
  function performUserSearch(keyword)
  {
	  if(keyword.length>3)
		{    		
 		 $.ajax( {
  		  url:  "ajax/getUserDetails?keyword="+ keyword,        
  
 			   success: function( data ) {
  		    log( data );
 		   }
		   } );
		}
	else
		{    		
		   	$("#log").hide();
		      		
		}
  }
  
  $( function() {
   
 
    $( "#f_name" ).on("keyup",function() {
    	
    	performUserSearch($(this).val());
        
      });
  } );
  </script>
	
</body>
</html>
